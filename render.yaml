projects:
  - name: cadmapper
    environments:
      - name: staging
        services:
          # Django Backend API
          - type: web
            name: cmneo-backend
            runtime: python
            region: oregon
            buildCommand: "cd backend && pip install -r requirements.txt && python manage.py collectstatic --noinput && python manage.py migrate"
            startCommand: "cd backend && gunicorn config.wsgi:application --bind 0.0.0.0:$PORT"
            envVars:
              - key: DJANGO_SETTINGS_MODULE
                value: config.settings
              - key: PYTHON_VERSION
                value: 3.11.0
              - key: DEBUG
                value: False
              - key: DJANGO_SECRET_KEY
                generateValue: true
              - key: JWT_SECRET
                generateValue: true
              - key: MAGIC_LINK_SECRET
                generateValue: true
              - key: DATABASE_URL
                fromDatabase:
                  name: cmneo-db
                  property: connectionString
              - key: CORS_ALLOWED_ORIGINS
                sync: false
              - key: DEFAULT_FROM_EMAIL
                sync: false
              - key: AWS_ACCESS_KEY_ID
                sync: false
              - key: AWS_SECRET_ACCESS_KEY
                sync: false
              - key: AWS_SES_REGION
                value: us-east-1
            healthCheckPath: /health/

          # Astro Frontend (Static Site)
          - type: web
            name: cmneo-frontend
            runtime: static
            buildCommand: "cd frontend && npm install && npm run build"
            staticPublishPath: frontend/dist
            envVars:
              - key: NODE_VERSION
                value: 20.11.0
              - key: PUBLIC_API_URL
                value: https://cmneo-backend.onrender.com/api

        databases:
          # You can also use Amazon RDS by removing this and configuring DATABASE_URL manually
          - name: cmneo-db
            region: oregon
            databaseName: cmneo
            user: cmneo
